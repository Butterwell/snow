<!DOCTYPE html>
<html>
  <head>
    <title>The Making of "A Short History of Snowfall"</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .subtitle {
        font-size: 60%;
        white-space: nowrap;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      #source {
        /* Hide the blog title and post titles while web fonts are loading */
        visibility: hidden;
      }

      /* Histogram Styling */
      .bar rect {
        fill: steelblue;
        shape-rendering: crispEdges;
      }

      .bar text {
        fill: #fff;
      }

      .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

/*
      body {
  background: #fcfcfa;
  height: 500px;
  position: relative;
  width: 960px;
}
*/
.stroke {
  fill: none;
  stroke: #000;
  stroke-width: 3px;
}

.fill {
  fill: #fff;
}

.graticule {
  fill: none;
  stroke: #999;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.land {
  fill: #777;
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}


    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# The Making of "A Short History of Snowfall"
## (Also, the working specification)

---

# Concept
## Show the amount of snowfall on a map for each year.
This treatment inspired by the record-breaking snowfall in Boston for the winter of 2014-2015.
* A REST API to query world-wide weather station measurements is available at: http://www.ncdc.noaa.gov/cdo-web/api/v2/...
* Instructions on how to get a developer token to access the data are here: http://www.ncdc.noaa.gov/cdo-web/webservices/v2

---

# The Perfect Dataset
What dataset would make project trivial?
* Evenly spaced data
* Daily measurements
* Covering the earth
* For all the earth for all of recorded history

Let's start with where measurements are made: weather stations. In particular...

---

# Snow Weather Stations

The API delivers a maximum of 1000 records a call.

To get the first 1000 weather stations by date with curl:
```bash
token=ThisIsNotAVaildToken
curl --header "Token: $token" --get \
-d datatypeid=SNOW -d limit=1000 -d sortfield=mindate \
www.ncdc.noaa.gov/cdo-web/api/v2/stations > earliest_1000_snow_stations.json
```
This is the same as, given the nodejs file get.js:

```JavaScript
var request = require('request');

var options = {
    headers: { 'Token': 'ThisIsNotAValidToken' },
    uri: 'https://www.ncdc.noaa.gov/cdo-web/api/v2/stations'+
         '?datatypeid=SNOW&limit=1000&sortfield=mindate'
};

request(options, function (error, resp, body) {
    console.log(body)
});
```
```bash
node get.js > earliest_1000_snow_stations.json
```
---

# Earliest Weather Stations Measuring Snowfall .subtitle[by Founding Year using D3]

.station_founding_year[]

---

# Number of Weather Stations Measuring Snowfall .subtitle[the Early Years]

.stations_active_by_year[]

At this point we don't know where any of these stations are. They might all be in...

---

# Canada - .subtitle[ Earliest Weather Stations Measuring Snow]

.early_station_map[]

---

Not all, but many are.  This could be misleading... we don't know if there are any measurements for any of these stations. Let's grab some data.

---

# Daily Snow Measurements Dataset (Jquery)
The station information is at the top level of the API. Here's how to search the "datasets" dataset to find all the datasets than have "SNOW", the datatypeid of the field we want:
```JavaScript
var token="ThisIsNotAVaildToken"
var url="https://www.ncdc.noaa.gov/cdo-web/api/v2/datasets?datatypeid=SNOW"
var snow_dataset;
$.ajax({ url: url, data:{}, headers:{ token: token } })
 .done(function (data) {
   snow_dataset = {
     dataset: data.results[0].id,
     mindate: data.results[0].mindate,
     maxdate: data.results[0].maxdate
   }
 })
```
This gaves us the dataset name with the SNOW data. D3 has a xhr/ajax nice xhr/ajax interface:
```JavaScript
d3.json("https://www.ncdc.noaa.gov/cdo-web/api/v2/datasets")
  .header("token", token)
  .get("datatypeid=SNOW", function(error, data) {
      // callback
  });
```
---

# Minimum Visualization Data (1)

Poking around at the data with curl, we find out that the maximum time span is one year. Since we're interested in snow, we break the year at July 1st. We also want a year with under 1000 entries, the maximum allowed in one call.
```bash
curl --header "token: $token" --get -d datasetid=GHCND \
-d startdate=1859-07-01 -d enddate=1860-07-01 -d datatypeid=SNOW -d limit=1000 \
www.ncdc.noaa.gov/cdo-web/api/v2/data > winter_snow_1859_1860.json
```

---

# Minimum Visualization Data (2)

There are 499 entries for this winter. Let's plot the count of non-zero entries.

.snow_measures_1859_1860[]

Several entries at the 230 mark, that's in mm. Boston values for January 1st and 2nd, 2014.

.snow_measures_2014_01_01[]

There are 226 entries and about the same distribution. 230mm is about 9".

---


# GeoJSON and TopoJSON

---

# Projections
* https://github.com/mbostock/d3/wiki/Geo-Projections
* http://bl.ocks.org/mbostock/3711652

---

# Irregularities
* Stations are not in a grid
* Stations do not have data every day
* Stations are added and removed over time
# Snowfall
* First available snowfall measure
* Coverage Dates

---

# How Much Data

---

# Offline Considerations
## Manifest File

---

# Drawing Mountains of Snow

---

# Hexagonal Binning
* https://github.com/d3/d3-plugins/tree/master/hexbin
* http://bl.ocks.org/mbostock/4248145
* http://bl.ocks.org/mbostock/4248146
* http://bl.ocks.org/mbostock/4330486

---

# Voronoi Tessellation
* http://bl.ocks.org/mbostock/4060366

---

# Melting
* Not all stations measure current depth.
* Since we were not showing the melting all along, is melting lieing?
* First pass: reset to 0 depth on July 1st.

---

# Wait... How Long is This Going to Take?
* We have data from 186x to 2015.
If we display a day's worth of information in one frame, and run the visualization at twenty-four frames a second, a year takes about a second and a half to display. ((2015-1860)*365/24)/60 = 39 minutes. 

---

# Providing more information
* Minimum yearly, maximum yearly on hover
* Location name

---

# A Need for Speed
* What is the fastest we can deliver it the first time
* What is the fastest we can deliver it subsequent times
* Station Encoding
* Snowfall Encoding
* Progressive enhancement
* Additional benifit, don't expose token

---

# Only the Data We Need
* JSON encoded
* CSV encoded

---

# NOAA Available Data
It took some exploration of the datatypeids to find "SNOW". Here's a list.


    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="year_histogram.js"></script>
    <script src="map.js"></script>
    <script>
      var slideshow = remark.create();
      document.getElementById('source').style.visibility = 'visable';
      slideshow.on('showSlide', function (slide) {
        // slide being navigated to
      });
      slideshow.on('hideSlide', function (slide) {
        // slide being navigated away from
      });
      // disables remark's interactions, allowing user to program custom event handlers
      // for keyboard events, etc...)
      //   slideshow.pause()
      // re-enables remarks default interaction event handlers
      //   slideshow.resume()

      function station_to_geojson(json) {
        return
          json.filter( function(p){ return p.latitude && p.longitude } )
              .map(function(p){
                 return {
                   "type": "Point",
                   "coordinates": [p.longitude, p.latitude], // , p.elevation]
                 }
              })
      }

      // Active Station Plots
      var station_data;
      d3.json("earliest_1000_snow_stations.json", function(error, json) {
        if (error) return console.warn(error);
        station_data = json.results
        var founding_years = station_data.map(function(d) { return parseInt(d.mindate.substr(0,4)) })
        var before_1890 = founding_years.filter(function(d) { return d < 1890 })
        year_histogram({ selectee: ".station_founding_year", width: 700, height: 300 }, before_1890 )
        year_histogram({ selectee: ".stations_active_by_year", width: 700, height: 300, running_total: true }, before_1890 )
        var p = station_to_geojson(station_data)
        map({ selectee: ".early_station_map", width: 800, height: 600 }, p )
      });
      d3.json("winter_snow_1859_1860.json", function(error, json) {
        if (error) return console.warn(error);
        var reports = json.results
        var non_zero = reports.filter(function(d) { return d.value != 0 }).map(function(d) { return d.value })
        year_histogram({ selectee: ".snow_measures_1859_1860", width: 700, height: 150 }, non_zero )
      });

      d3.json("snow_2014_01_01_2014_01_02.json", function(error, json) {
        if (error) return console.warn(error);
        var reports = json.results
        var non_zero = reports.filter(function(d) { return d.value != 0 }).map(function(d) { return d.value })
        year_histogram({ selectee: ".snow_measures_2014_01_01", width: 700, height: 150 }, non_zero )
      });
      
    </script>
  </body>
</html>
