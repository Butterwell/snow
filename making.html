<!DOCTYPE html>
<html>
  <head>
    <title>The Making of "A Short History of Snowfall"</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      #source {
        /* Hide the blog title and post titles while web fonts are loading */
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# The Making of "A Short History of Snowfall"
## (Also, the working specification)

---

# Concept
## Show the amount of snowfall on a map for each year.
This treatment inspired by the record-breaking snowfall in Boston for the winter of 2014-2015.
* A REST API to query world-wide weather station measurements is available at: http://www.ncdc.noaa.gov/cdo-web/api/v2/...
* Instructions on how to get a developer token to access the data are here: http://www.ncdc.noaa.gov/cdo-web/webservices/v2

---

# Daily Snow Measurements Dataset (Jquery)
NOAA information is directly available from the browser using the token:
```JavaScript
var token="ThisIsNotAVaildToken"
var url="https://www.ncdc.noaa.gov/cdo-web/api/v2/datasets?datatypeid=SNOW"
var snow_dataset;
$.ajax({ url: url, data:{}, headers:{ token: token } })
 .done(function (data) {
   snow_dataset = {
     dataset: data.results[0].id,
     mindate: data.results[0].mindate,
     maxdate: data.results[0].maxdate
   }
 })
```
This gaves us the dataset name with the SNOW data. To save a xhr(ajax) call, calculate the enddate:
```JavaScript
var milli_since_1970 = new Date().getTime()
var maxdate = new Date()
maxdate.setTime( milli_since_1970 - 2 * 86400000 ) // A couple of days ago
var snow_dataset = {
  dataset: "GHCND",
  mindate: "1763-01-01",
  maxdate: maxdate.toISOString().split("T")[0]
}

```

---

# Minimum Visualization Data
Poking around at the data with curl, we find out that the maximum time span is one year. Since we're interested in snow, we break the year at July 1st. We also want a year with under 1000 entries, the maximum allowed in one call.
```bash
curl --header "token: $token" --get -d datasetid=GHCND \
-d startdate=1859-07-01 -d enddate=1860-07-01 -d datatypeid=SNOW -d limit=1000 \
www.ncdc.noaa.gov/cdo-web/api/v2/data > winter_snow_1859_1860.json
```
---

# A Bit About curl
curl is a one-shot workhorse. To get the first 500 weather stations by date:
```bash
token=ThisIsNotAVaildToken
curl --header "Token: $token" --get \
-d datatypeid=SNOW -d limit=500 -d sortfield=mindate \
www.ncdc.noaa.gov/cdo-web/api/v2/stations > first_500_stations.json
```
This is the same as, given the nodejs file get.js:

```JavaScript
var request = require('request');

var options = {
    headers: { 'Token': 'ThisIsNotAValidToken' },
    uri: 'https://www.ncdc.noaa.gov/cdo-web/api/v2/stations'+
         '?datatypeid=SNOW&limit=500&sortfield=mindate'
};

request(options, function (error, resp, body) {
    console.log(body)
});
```
```bash
node get.js > first_500_stations.json
```
---

# A Histogram of Earliest Weather Stations
## by Founding Year using D3
* https://github.com/mbostock/d3/wiki/Histogram-Layout
* http://bl.ocks.org/mbostock/3048450
* http://bl.ocks.org/mbostock/raw/3048450

---

# A Map of the Earliest Weather Stations
## also using D3

---

# GeoJSON and TopoJSON

---

# Projections
* https://github.com/mbostock/d3/wiki/Geo-Projections
* http://bl.ocks.org/mbostock/3711652

---

# The Perfect Dataset
What dataset would make this trivial? The perfect dataset would be a evenly spaced hex grid (binned) daily measurements of all the earth for all of recorded history. That is, a regular grid hex where every hex had a measurement for every day.

---

# Irregularities
* Stations are not in a grid
* Stations do not have data every day
* Stations are added and removed over time
# Snowfall
* First available snowfall measure
* Coverage Dates

---

# How Much Data

---

# Offline Considerations
## Manifest File

---

# Drawing Mountains of Snow

---

# Hexagonal Binning
* https://github.com/d3/d3-plugins/tree/master/hexbin
* http://bl.ocks.org/mbostock/4248145
* http://bl.ocks.org/mbostock/4248146
* http://bl.ocks.org/mbostock/4330486

---

# Voronoi Tessellation
* http://bl.ocks.org/mbostock/4060366

---

# Melting
* Not all stations measure current depth.
* Since we were not showing the melting all along, is melting lieing?
* First pass: reset to 0 depth on July 1st.

---

# Wait... How Long is This Going to Take?
* We have data from 186x to 2015.
If we display a day's worth of information in one frame, and run the visualization at twenty-four frames a second, a year takes about a second and a half to display. ((2015-1860)*365/24)/60 = 39 minutes. 

---

# Providing more information
* Minimum yearly, maximum yearly on hover
* Location name

---

# A Need for Speed
* What is the fastest we can deliver it the first time
* What is the fastest we can deliver it subsequent times
* Station Encoding
* Snowfall Encoding
* Progressive enhancement
* Additional benifit, don't expose token

---

# Only the Data We Need
* JSON encoded
* CSV encoded

---

# NOAA Available Data
It took some exploration of the datatypeids to find "SNOW". Here's a list.


    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script>
      var slideshow = remark.create();
      document.getElementById('source').style.visibility = 'visable';
      slideshow.on('showSlide', function (slide) {
        // slide being navigated to
      });
      slideshow.on('hideSlide', function (slide) {
        // slide being navigated away from
      });
      // disables remark's interactions, allowing user to program custom event handlers
      // for keyboard events, etc...)
      //   slideshow.pause()
      // re-enables remarks default interaction event handlers
      //   slideshow.resume()
    </script>
  </body>
</html>
